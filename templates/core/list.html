{% extends "presente/private_base.html" %}
{% load render_table from django_tables2 %}
{% load filter_tags %}

{% block title %}{{ page_title }}{% endblock %}

{% block page_title %}{{ page_title }}{% endblock %}

{% block crumb %}
{{ block.super }}
<li class="breadcrumb-item active" aria-current="page">{{ page_title }}</li>
{% endblock %}

{% block app_content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div id="filter-button-wrapper">
      {% if filter %}
      {% has_active_filters filter as filters_active %}
      <button class="btn {% if filters_active %}btn-primary{% else %}btn-outline-secondary{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse" {% if filters_active %}aria-expanded="true"{% endif %}>
        <i class="bi bi-funnel{% if filters_active %}-fill{% endif %}"></i> Filtros
        {% if filters_active %}
        <span class="badge bg-light text-dark ms-1">{{ filter.qs.count }}</span>
        {% endif %}
      </button>
      {% endif %}
    </div>
    <div>
      {% block extra_actions %}
      {% endblock %}
      {% if "add" in allowed_actions %}
      <a href="{% url allowed_actions.add %}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Novo
      </a>
      {% endif %}
    </div>
  </div>

  {% if filter %}
  {% has_active_filters filter as filters_active %}
  <div class="collapse {% if filters_active %}show{% endif %} mb-3" id="filterCollapse">
    <div class="card">
      <div class="card-body">
        <form method="get" id="filter-form" class="row g-3" hx-get="{{ request.path }}" hx-target="#table-wrapper" hx-push-url="true" hx-trigger="change delay:300ms, submit">
          {% for field in filter.form %}
            {% if field.name != 'csrfmiddlewaretoken' %}
            <div class="col-md-4">
              <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
              {{ field }}
              {% if field.errors %}
                <div class="invalid-feedback d-block">
                  {{ field.errors }}
                </div>
              {% endif %}
            </div>
            {% endif %}
          {% endfor %}
          <div class="col-12">
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-search"></i> Filtrar
            </button>
            <a href="{{ request.path }}" class="btn btn-secondary" hx-get="{{ request.path }}" hx-target="#table-wrapper" hx-push-url="true" hx-on::after-request="const form = this.closest('form'); form.reset(); form.querySelectorAll('select').forEach(el => el.tomselect?.clear());">
              <i class="bi bi-x-circle"></i> Limpar
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% endif %}

  <div id="table-wrapper">
    {% include "core/includes/table_content.html" %}
  </div>
</div>
{% endblock %}
