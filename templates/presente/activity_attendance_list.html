{% extends "presente/private_base.html" %}
{% load render_table from django_tables2 %}
{% load filter_tags %}

{% block title %}{{ page_title }}{% endblock %}

{% block page_title %}{{ page_title }}{% endblock %}

{% block crumb %}
{{ block.super }}
<li class="breadcrumb-item"><a href="{% url 'presente:activity_list' %}">Atividades</a></li>
<li class="breadcrumb-item"><a href="{% url 'presente:activity_view' activity.pk %}">{{ activity.title }}</a></li>
<li class="breadcrumb-item active" aria-current="page">Presenças</li>
{% endblock %}

{% block extra_body %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize Tom Select for filter forms
  function initializeFilterTomSelect() {
    // Simple select dropdowns (single select) - used in filters
    document.querySelectorAll('[data-tom-select="simple"]').forEach(function(el) {
      if (!el.tomselect) {
        new TomSelect(el, {
          persist: false,
          create: false,
          allowEmptyOption: true,
          placeholder: el.getAttribute('placeholder') || 'Selecione...',
        });
      }
    });
  }

  // Run initialization after a delay to catch dynamically loaded elements
  setTimeout(initializeFilterTomSelect, 100);
  setTimeout(initializeFilterTomSelect, 500);

  // Also run when filter collapse is shown
  const filterCollapse = document.getElementById('filterCollapse');
  if (filterCollapse) {
    filterCollapse.addEventListener('shown.bs.collapse', function() {
      setTimeout(initializeFilterTomSelect, 50);
    });
  }
});
</script>
{% endblock %}

{% block app_content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      {% if filter %}
      {% has_active_filters filter as filters_active %}
      <button class="btn {% if filters_active %}btn-primary{% else %}btn-outline-secondary{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse" {% if filters_active %}aria-expanded="true"{% endif %}>
        <i class="bi bi-funnel{% if filters_active %}-fill{% endif %}"></i> Filtros
        {% if filters_active %}
        <span class="badge bg-light text-dark ms-1">{{ filter.qs.count }}</span>
        {% endif %}
      </button>
      {% endif %}
    </div>
    <div>
      <button
        class="btn btn-success me-2"
        hx-get="{% url 'presente:activity_attendance_print_config' activity.pk %}?{{ request.GET.urlencode }}"
        hx-target="#modals-here .modal-content"
        hx-trigger="click"
        data-bs-toggle="modal"
        data-bs-target="#modals-here">
        <i class="bi bi-printer"></i> Imprimir Relatório
      </button>
      {% if "add" in allowed_actions %}
      <a href="{% url allowed_actions.add %}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Novo
      </a>
      {% endif %}
    </div>
  </div>

  {% if filter %}
  {% has_active_filters filter as filters_active %}
  <div class="collapse {% if filters_active %}show{% endif %} mb-3" id="filterCollapse">
    <div class="card">
      <div class="card-body">
        <form method="get" class="row g-3">
          {% for field in filter.form %}
            {% if field.name != 'csrfmiddlewaretoken' %}
            <div class="col-md-4">
              <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
              {{ field }}
              {% if field.errors %}
                <div class="invalid-feedback d-block">
                  {{ field.errors }}
                </div>
              {% endif %}
            </div>
            {% endif %}
          {% endfor %}
          <div class="col-12">
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-search"></i> Filtrar
            </button>
            <a href="{{ request.path }}" class="btn btn-secondary">
              <i class="bi bi-x-circle"></i> Limpar
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% endif %}

  <div class="card">
    <div class="card-body p-0">
      {% render_table table %}
    </div>
  </div>
</div>
{% endblock %}
