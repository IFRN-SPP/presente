{% extends 'presente/base.html' %}
{% load static %}

{% block title %}{{ activity.title }}{% endblock %}

{% block body_class %}public-activity-page{% endblock %}

{% block extra_head %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/qrcode_page.css' %}" />
{% endblock %}

{% block app_wrapper %}
<div class="min-vh-100 d-flex flex-column p-3 qr-gradient">
  <div class="bg-white rounded-4 shadow flex-fill d-flex flex-column overflow-hidden mx-auto w-100" style="max-width: 1200px;">
    <div class="qr-header-gradient text-white p-3 text-center">
      <h1 class="h3 fw-bold mb-0"><i class="bi bi-calendar-event"></i> {{ activity.title }}</h1>
    </div>

    <div class="d-flex justify-content-center align-items-center gap-2 py-2 px-3 bg-light border-bottom" style="font-size: 0.85rem;">
      <i class="bi bi-calendar3 text-primary"></i>
      <span id="current-date"></span>
      <span class="text-muted">•</span>
      <i class="bi bi-clock text-primary"></i>
      <span id="current-time"></span>
    </div>

    <div class="flex-fill d-flex flex-column p-3 justify-content-between gap-2">
      <div class="d-flex justify-content-center gap-2 flex-wrap">
        <div class="text-center p-2 bg-light rounded shadow-sm flex-fill" style="min-width: 140px; max-width: 220px;">
          <div class="text-uppercase text-muted fw-semibold" style="font-size: 0.7rem; letter-spacing: 0.5px;">
            <i class="bi bi-clock-fill me-1"></i> Início
          </div>
          <div class="fw-bold fs-6">{{ activity.start_time|date:"d/m/Y H:i" }}</div>
        </div>
        <div class="text-center p-2 bg-light rounded shadow-sm flex-fill" style="min-width: 140px; max-width: 220px;">
          <div class="text-uppercase text-muted fw-semibold" style="font-size: 0.7rem; letter-spacing: 0.5px;">
            <i class="bi bi-clock-fill me-1"></i> Término
          </div>
          <div class="fw-bold fs-6">{{ activity.end_time|date:"d/m/Y H:i" }}</div>
        </div>
      </div>

      <div class="text-center flex-fill d-flex flex-column justify-content-center align-items-center">
        <div id="qr-code-container"
             hx-get="{% url 'presente:activity_qr' encoded_id %}"
             hx-trigger="load"
             hx-swap="innerHTML transition:true">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando...</span>
          </div>
        </div>
        <div id="qr-error-container" class="d-none">
          <div class="alert alert-danger text-center">
            <i class="bi bi-exclamation-triangle fs-1 d-block mb-3"></i>
            <h5>Erro de Conexão</h5>
            <p class="mb-0">Não foi possível carregar o QR Code. Verifique sua conexão com a internet.</p>
          </div>
        </div>
      </div>

      <div class="mt-auto pt-2 border-top text-center">
        <div class="d-flex align-items-center justify-content-center gap-2">
          <img src="{% static 'img/presente-icon.svg' %}" alt="presente!" style="height: 24px;">
          <span class="fw-bold">presente!</span>
          <span class="text-muted">|</span>
          <span class="text-muted small">&copy; IFRN/SPP - {% now 'Y' %}</span>
        </div>
      </div>
    </div>
  </div>
</div>

{% block extra_script %}
{{ block.super }}
<script src="{% static 'js/qrcode.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const qrContainer = document.getElementById('qr-code-container');
  const errorContainer = document.getElementById('qr-error-container');

  if (qrContainer) {
    qrContainer.addEventListener('htmx:responseError', function() {
      qrContainer.classList.add('d-none');
      errorContainer.classList.remove('d-none');
    });

    qrContainer.addEventListener('htmx:sendError', function() {
      qrContainer.classList.add('d-none');
      errorContainer.classList.remove('d-none');
    });

    qrContainer.addEventListener('htmx:timeout', function() {
      qrContainer.classList.add('d-none');
      errorContainer.classList.remove('d-none');
    });
  }
});
</script>
{% endblock %}

{% endblock %}
