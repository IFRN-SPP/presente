{% extends 'presente/base.html' %}
{% load static %}

{% block title %}{{ activity.title }}{% endblock %}

{% block body_class %}public-activity-page{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
{% endblock %}

{% block app_wrapper %}
<div class="fullscreen-container">
  <div class="activity-card">
    <div class="activity-header">
      <h1><i class="bi bi-calendar-event"></i> {{ activity.title }}</h1>
    </div>

    <div class="activity-body">
      <div class="time-info">
        <div class="time-block">
          <div class="time-label"><i class="bi bi-clock-fill"></i> Início</div>
          <div class="time-value">{{ activity.start_time|date:"d/m/Y H:i" }}</div>
        </div>
        <div class="time-block">
          <div class="time-label"><i class="bi bi-clock-fill"></i> Término</div>
          <div class="time-value">{{ activity.end_time|date:"d/m/Y H:i" }}</div>
        </div>
      </div>

      <div class="qr-section">
        <div class="qr-title">Escaneie ou clique para registrar presença</div>

        <div id="qr-code-container"
             hx-get="{% url 'presente:activity_qr' encoded_id %}"
             hx-trigger="load"
             hx-swap="innerHTML transition:true">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando...</span>
          </div>
        </div>
        <div id="qr-error-container" style="display: none;">
          <div class="alert alert-danger text-center">
            <i class="bi bi-exclamation-triangle fs-1 d-block mb-3"></i>
            <h5>Erro de Conexão</h5>
            <p class="mb-0">Não foi possível carregar o QR Code. Verifique sua conexão com a internet.</p>
          </div>
        </div>
      </div>

      <div class="page-footer">
        <div class="footer-content">
          <img src="{% static 'img/presente-icon.svg' %}" alt="presente!" class="footer-logo">
          <span class="footer-text">presente!</span>
          <span class="footer-separator">|</span>
          <span class="footer-copyright">&copy; IFRN/SPP - {% now 'Y' %}</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const qrContainer = document.getElementById('qr-code-container');
  const errorContainer = document.getElementById('qr-error-container');

  if (qrContainer) {
    // Listen for HTMX errors
    qrContainer.addEventListener('htmx:responseError', function(event) {
      qrContainer.style.display = 'none';
      errorContainer.style.display = 'block';
    });

    qrContainer.addEventListener('htmx:sendError', function(event) {
      qrContainer.style.display = 'none';
      errorContainer.style.display = 'block';
    });

    qrContainer.addEventListener('htmx:timeout', function(event) {
      qrContainer.style.display = 'none';
      errorContainer.style.display = 'block';
    });
  }
});
</script>
{% endblock %}
