<div id="qr-code-container"
     hx-get="{% url 'presente:activity_qr' encoded_id %}"
     hx-trigger="load delay:{{ timeout }}s"
     hx-swap="outerHTML">
  <div class="text-center">
    <a href="{{ checkin_url }}" id="qrcode" class="mb-3 d-flex justify-content-center" style="cursor: pointer; text-decoration: none;"></a>
    <p class="text-muted small mt-3">
      <i class="bi bi-clock"></i> Renovando em <span id="countdown-text">{{ timeout }}</span> segundos
    </p>
  </div>
</div>

<script>
(function() {
  const timeout = {{ timeout }};
  let timeLeft = timeout;

  // Wait for QRCode library to be available
  function initQRCode() {
    const qrcodeDiv = document.getElementById("qrcode");
    if (qrcodeDiv && !qrcodeDiv.hasChildNodes() && typeof QRCode !== 'undefined') {
      new QRCode(qrcodeDiv, {
        text: "{{ checkin_url }}",
        width: 256,
        height: 256,
        colorDark : "#000000",
        colorLight : "#ffffff",
        correctLevel : QRCode.CorrectLevel.H
      });

      // Start countdown
      startCountdown();
    } else if (typeof QRCode === 'undefined') {
      // If QRCode is not loaded yet, try again in 50ms
      setTimeout(initQRCode, 50);
    }
  }

  function startCountdown() {
    const countdownText = document.getElementById('countdown-text');
    if (!countdownText) return;

    const interval = setInterval(function() {
      timeLeft--;
      countdownText.textContent = timeLeft;

      if (timeLeft <= 0) {
        clearInterval(interval);
      }
    }, 1000);
  }

  initQRCode();
})();
</script>
