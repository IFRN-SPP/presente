{% load static %}

{% if activity.status == 'not_started' %}
  <div class="alert alert-info text-center mb-0"
       hx-get="{% url 'presente:activity_qr' encoded_id %}"
       hx-trigger="load delay:5s"
       hx-swap="innerHTML transition:true"
       hx-target="#qr-code-container">
    <i class="bi bi-hourglass-split fs-1 d-block mb-3"></i>
    <h5>Aguarde o Início</h5>
    <p class="mb-3">O QR Code será exibido automaticamente quando o registro de presença estiver disponível.</p>

    <div class="badge bg-info text-dark fs-6 px-3 py-2">
      <i class="bi bi-clock-fill me-2"></i>
      Inicia em: <span id="start-countdown" class="fw-bold">calculando...</span>
    </div>
  </div>

{% elif activity.status == 'expired' %}
  <div class="alert alert-warning text-center">
    <i class="bi bi-clock-history fs-1 d-block mb-3"></i>
    <h5>Atividade Encerrada</h5>
    <p class="mb-0">Esta atividade já encerrou. Não é mais possível registrar presença.</p>
  </div>

{% elif activity.status == 'active' %}
  <div class="fs-5 fw-semibold text-dark mb-3">Escaneie ou clique para registrar presença</div>

  <div class="d-flex flex-column align-items-center m-0">
    <a href="{{ checkin_url }}" class="qr-code-link d-inline-block bg-white rounded-4 shadow p-2">
      <img src="{{ qr_data_url }}" alt="QR Code" class="img-fluid rounded m-0">
    </a>
    <div class="mt-3 text-muted">
      <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
      Renovando em <span id="countdown-text">{{ timeout }}</span>s
    </div>
  </div>

  <div hx-get="{% url 'presente:activity_qr' encoded_id %}"
       hx-trigger="load delay:{{ timeout }}s"
       hx-swap="innerHTML transition:true"
       hx-target="#qr-code-container"
       style="display:none;"></div>

{% else %}
  <div class="alert alert-danger text-center">
    <i class="bi bi-exclamation-triangle fs-1 d-block mb-3"></i>
    <h5>Erro</h5>
    <p class="mb-0">Erro ao gerar QR Code. Atividade não encontrada.</p>
  </div>
{% endif %}

<script>
(function() {
  if (window.qrManager) {
    window.qrManager.clearIntervals();
  }

  window.qrManager = new QRCodeManager("{{ server_time }}");

  window.qrManager.updateDateTime();

  {% if activity.status == 'not_started' %}
  window.qrManager.initActivityStartCountdown({{ seconds_until_start }});
  {% elif activity.status == 'active' %}
  window.qrManager.startQRCountdown({{ timeout }});
  {% endif %}
})();
</script>
