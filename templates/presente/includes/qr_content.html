{% load static %}

{% if activity.status == 'not_started' %}
  <div class="alert alert-info text-center"
       hx-get="{% url 'presente:activity_qr' encoded_id %}"
       hx-trigger="load delay:5s"
       hx-swap="innerHTML transition:true"
       hx-target="#qr-code-container">
    <i class="bi bi-hourglass-split fs-1 d-block mb-3"></i>
    <h5>Aguarde o Início</h5>
    <p class="mb-2">O QR Code será exibido automaticamente quando o registro de presença estiver disponível.</p>

    <div class="mt-3 mb-3">
      <div class="badge bg-info text-dark fs-6 px-3 py-2">
        <i class="bi bi-clock-fill me-2"></i>
        Inicia em: <span id="start-countdown" class="fw-bold">calculando...</span>
      </div>
    </div>
  </div>

{% elif activity.status == 'expired' %}
  <div class="alert alert-warning text-center">
    <i class="bi bi-clock-history fs-1 d-block mb-3"></i>
    <h5>Atividade Encerrada</h5>
    <p class="mb-0">Esta atividade já encerrou. Não é mais possível registrar presença.</p>
  </div>

{% elif activity.status == 'active' %}
  <div class="qr-title">Escaneie ou clique para registrar presença</div>

  <div class="qr-wrapper">
    <a href="{{ checkin_url }}" id="qrcode" class="qr-code-link qr-fade-in"></a>
    <div class="qr-countdown">
      <i class="bi bi-arrow-clockwise"></i> Renovando em <span id="countdown-text">{{ timeout }}</span>s
    </div>
  </div>

  <div hx-get="{% url 'presente:activity_qr' encoded_id %}"
       hx-trigger="load delay:{{ timeout }}s"
       hx-swap="innerHTML transition:true"
       hx-target="#qr-code-container"
       style="display:none;"></div>

{% else %}
  <div class="alert alert-danger text-center">
    <i class="bi bi-exclamation-triangle fs-1 d-block mb-3"></i>
    <h5>Erro</h5>
    <p class="mb-0">Erro ao gerar QR Code. Atividade não encontrada.</p>
  </div>
{% endif %}

<script>
(function() {
  const qrManager = new QRCodeManager("{{ server_time }}");

  qrManager.updateDateTime();

  {% if activity.status == 'not_started' %}
  qrManager.initActivityStartCountdown("{{ activity.start_time|date:'c' }}");
  {% elif activity.status == 'active' %}
  qrManager.initQRCode("{{ checkin_url }}", {{ timeout }});
  {% endif %}
})();
</script>
